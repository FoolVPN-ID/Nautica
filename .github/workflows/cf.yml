name: â›… Deploy to Cloudflare Workers

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - testing

jobs:
  validate:
    name: ðŸ” Validate Worker Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ” Check JavaScript syntax
        run: |
          echo "::group::Syntax Check"
          node --check _worker.js
          echo "âœ… Syntax check passed"
          echo "::endgroup::"

      - name: ðŸ“ Check file integrity
        run: |
          echo "::group::File Integrity Check"
          
          # Check if file is complete (no truncation)
          if ! tail -1 _worker.js | grep -q '[;}]'; then
            echo "::error::_worker.js appears truncated (missing closing bracket/semicolon)"
            exit 1
          fi
          
          # Check file size (should be > 20KB for a complete worker)
          SIZE=$(stat -f%z _worker.js 2>/dev/null || stat -c%s _worker.js)
          if [ "$SIZE" -lt 20000 ]; then
            echo "::error::_worker.js file size too small ($SIZE bytes), possible truncation"
            exit 1
          fi
          
          echo "âœ… File size: $SIZE bytes"
          echo "âœ… File integrity check passed"
          echo "::endgroup::"

      - name: ðŸ”¬ Lint with ESLint (optional)
        continue-on-error: true
        run: |
          echo "::group::ESLint Check"
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            bun run eslint _worker.js || echo "::warning::ESLint found issues (non-blocking)"
          else
            echo "::notice::No ESLint config found, skipping linting"
          fi
          echo "::endgroup::"

      - name: ðŸ§ª Wrangler dry-run (syntax + config validation)
        run: |
          echo "::group::Wrangler Validation"
          bunx wrangler deploy --dry-run --outdir=./dist
          echo "âœ… Wrangler dry-run passed"
          echo "::endgroup::"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: âœ… Validation complete
        run: |
          echo "::notice::All validation checks passed!"
          echo "::notice::File: _worker.js"
          echo "::notice::Branch: ${{ github.ref_name }}"

  deploy:
    name: ðŸš€ Deploy Worker
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validate  # Only deploy if validation passes
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸš€ Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          wranglerVersion: "4.55.0"
        env:
          GIT_COMMIT_ID: ${{ github.sha }}

      - name: ðŸ§ª Post-deployment smoke test
        run: |
          echo "::group::Smoke Test"
          
          # Wait for deployment to propagate
          sleep 5
          
          # Get worker URL from wrangler
          WORKER_URL=$(bunx wrangler deployments list --json 2>/dev/null | jq -r '.[0].url' || echo "")
          
          if [ -z "$WORKER_URL" ]; then
            echo "::warning::Could not determine worker URL, skipping smoke test"
            exit 0
          fi
          
          echo "Testing: $WORKER_URL"
          
          # Test root endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$WORKER_URL/" || echo "000")
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            echo "âœ… Root endpoint returned $HTTP_CODE"
          else
            echo "::error::Root endpoint failed with code $HTTP_CODE"
            exit 1
          fi
          
          # Test API endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$WORKER_URL/api/v1/myip" || echo "000")
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… API endpoint returned $HTTP_CODE"
          else
            echo "::warning::API endpoint returned $HTTP_CODE (non-critical)"
          fi
          
          echo "::endgroup::"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: âœ… Deployment complete
        run: |
          echo "::notice::Successfully deployed to Cloudflare Workers"
          echo "::notice::Branch: ${{ github.ref_name }}"
          echo "::notice::Commit: ${{ github.sha }}"
